# AGENTS.md

Guidance for coding agents working in `mail-imap-mcp-rs`.

## Project Snapshot

- Language: Rust (edition `2024`)
- Runtime: `tokio`
- Protocol framework: `rmcp`
- Domain: IMAP-backed MCP server over stdio
- Entry point: `src/main.rs`
- Main server implementation: `src/server.rs`

## Cursor/Copilot Rules

No repository-specific Cursor or Copilot instruction files were found:

- `.cursorrules`: not present
- `.cursor/rules/`: not present
- `.github/copilot-instructions.md`: not present

If these are added later, treat them as higher-priority local policy and merge them into this file.

## Build, Lint, and Test Commands

Run commands from repo root.

### Build

- Debug build: `cargo build`
- Release build: `cargo build --release`

### Format

- Check formatting: `cargo fmt -- --check`
- Apply formatting: `cargo fmt`

### Lint

- Strict clippy (all targets): `cargo clippy --all-targets -- -D warnings`

### Test

- Run all tests: `cargo test`
- List tests: `cargo test -- --list`
- GreenMail integration smoke test: `scripts/test-greenmail.sh`

### Run a Single Test

Use a test name substring:

- `cargo test parses_mailbox_with_colons`
- `cargo test pagination::tests::evicts_to_max_entries`

Run a single test and show stdout:

- `cargo test parses_mailbox_with_colons -- --exact --nocapture`
- `RUN_GREENMAIL_TESTS=1 cargo test greenmail_imap_smoke_test -- --exact --nocapture`

Run tests in one module/file scope:

- `cargo test message_id::tests`
- `cargo test mime::tests`
- `cargo test pagination::tests`

## Suggested Local Validation Sequence

Before finalizing changes, run:

1. `cargo fmt -- --check`
2. `cargo clippy --all-targets -- -D warnings`
3. `cargo test`

Do not skip clippy or tests for code changes.

## Docker

The repository includes a minimal multi-stage Dockerfile for running the MCP server.

### Build and Run

- Build image: `docker build -t mail-imap-mcp-rs .`
- Run over stdio: `docker run --rm -i --env-file .env mail-imap-mcp-rs`

### Docker Notes for Agents

- Keep MCP transport as stdio (do not add HTTP listener behavior by default).
- Keep runtime image minimal (current pattern: builder image + `scratch`).
- If dependencies require a non-scratch runtime, document why in the PR/commit message.
- Keep `.dockerignore` aligned with repo layout to avoid leaking local files and reduce context size.
- Docker publish workflow: `.github/workflows/publish-docker.yml`.
- Docker publish trigger: git tags matching `v*.*.*`.
- Published image tags include `latest`, `vX.Y.Z`, and `X.Y.Z` on GHCR.

## NPM / NPX Distribution

The project is distributed as a single npm package that bundles platform-specific binaries.

### Package Layout

- Base package: `npm/app/package.json` (`@bradsjm/mail-imap-mcp-rs`)
- Launcher script: `npm/app/bin/index.js`
- Publish workflow: `.github/workflows/publish-npm.yml`

### Runtime Behavior

- End users run via `npx @bradsjm/mail-imap-mcp-rs@latest`.
- The launcher resolves OS/arch and executes the bundled binary from package `bin/<platform>/`.
- Supported platform bundles are:
  - `linux-x64`
  - `darwin-x64`
  - `darwin-arm64`
  - `windows-x64`

### Publishing Rules for Agents

- Do not change package scope (`@bradsjm`) unless explicitly requested.
- Ensure `npm/app/bin/index.js` stays executable and continues to pass through stdio.
- Prefer CI-driven publishing via git tags (`v*.*.*`).
- Bootstrap first publish with `NPM_TOKEN`; use npm trusted publishing (OIDC) after package exists.

## Release Assets (Curl Installer)

The repository also publishes GitHub Release binary archives and a curl installer for Linux/macOS users.

### Release Workflow

- Asset workflow: `.github/workflows/release-assets.yml`
- Trigger: git tags matching `v*.*.*`
- Required assets:
  - `mail-imap-mcp-rs-linux-x64.tar.gz`
  - `mail-imap-mcp-rs-darwin-x64.tar.gz`
  - `mail-imap-mcp-rs-darwin-arm64.tar.gz`
- Additional release files:
  - `checksums.txt`
  - `mail-imap-mcp-rs-installer.sh`

### Installer Behavior and Guardrails

- Source script: `scripts/install/mail-imap-mcp-rs-installer.sh`
- Default install directory: `~/.local/bin`.
- The installer verifies SHA-256 checksums before installation.
- Linux target selection: `linux-x64`.
- Keep installer POSIX `sh` compatible (`curl ... | sh` usage).
- Do not change release asset naming without updating installer mapping logic.

### Tag Publish Flow

- `publish-npm.yml`, `release-assets.yml`, and `publish-docker.yml` run on `v*.*.*` tags.
- Keep npm package versions, release tag version, and installer embedded version aligned.
- If release automation changes, update `README.md` install commands and this file together.

## Architecture and File Ownership

- `src/main.rs`: process bootstrap, env loading, tracing init, stdio serving.
- `src/config.rs`: env-driven account/server config parsing.
- `src/errors.rs`: app-level error model and MCP error mapping.
- `src/imap.rs`: IMAP transport/session operations with timeout wrappers.
- `src/server.rs`: MCP tool handlers, validation, business orchestration.
- `src/models.rs`: input/output DTOs and schema-bearing types.
- `src/mime.rs`: message parsing, header/body extraction, sanitization.
- `src/message_id.rs`: stable message id parse/encode logic.
- `src/pagination.rs`: cursor storage and TTL/eviction behavior.

## Code Style Guidelines

### Imports

- Group imports in this order:
  1) standard library (`std::...`)
  2) external crates
  3) internal crate imports (`crate::...`)
- Keep imports explicit; avoid wildcard imports.
- Remove unused imports rather than allowing warnings.

### Formatting

- Use rustfmt defaults; do not hand-format against rustfmt.
- Keep line wrapping and chaining style consistent with existing files.
- Prefer small helper functions over deeply nested expressions.

### Types and Data Modeling

- Prefer concrete types and explicit bounds over implicit conversions.
- Use `AppResult<T>` for fallible internal APIs.
- Use `struct` types in `models.rs` for tool input/output contracts.
- Preserve serde defaults and validation bounds when extending inputs.
- Keep schema-annotated types (`JsonSchema`) aligned with runtime behavior.

### Naming

- Types: `UpperCamelCase`.
- Functions/methods: `snake_case`.
- Constants: `UPPER_SNAKE_CASE`.
- Use domain names that match IMAP/MCP vocabulary (`uidvalidity`, `mailbox`, `cursor`).
- Avoid abbreviations unless they are protocol-standard.

### Error Handling

- Never use `unwrap()` or `expect()` in production code paths.
- Convert external errors into `AppError` with actionable context.
- Prefer specific variants (`InvalidInput`, `NotFound`, `Conflict`, etc.) over `Internal` when possible.
- Keep user-facing error messages precise and bounded.
- Preserve mapping from `AppError` to `ErrorData` in `errors.rs`.

### Validation and Bounds

- Validate all user input before IMAP operations.
- Enforce existing numeric/string bounds (limit, chars, dates, bytes).
- Reject conflicting parameter combinations explicitly.
- Keep pagination and cursor invariants intact.

### Async and Timeouts

- All network/IMAP operations should be timeout-bounded.
- Reuse server-configured timeout settings; do not hardcode new timeout values.
- Keep async functions cancellation-safe and side effects clear.

### Security and Privacy

- Never log or return secrets (`*_PASS`, tokens, auth headers).
- Preserve TLS-only behavior unless a deliberate security design change is requested.
- Maintain HTML sanitization for message HTML (`ammonia`).
- Keep attachment extraction bounded and failure-tolerant.

### MCP Tool Behavior

- Keep tool names stable unless a breaking change is explicitly intended.
- Maintain `ToolEnvelope` shape (`summary`, `data`, `meta`).
- Keep `summary` concise and useful.
- Ensure `meta.duration_ms` and `meta.now_utc` remain populated.

### Testing Expectations

- Add unit tests for pure logic changes (parsing, validation, pagination, ids).
- Extend existing test modules near changed code.
- For bug fixes, add regression tests reproducing prior failure mode.

## Change Discipline for Agents

- Prefer minimal, focused diffs.
- Do not introduce compatibility shims unless requested.
- Do not silently alter public tool contracts.
- Update docs when behavior or bounds change.
- If adding env vars, document them in `docs/tool-contract.md` and this file.

## Quick Pre-Commit Checklist

- Code formatted
- Clippy clean with warnings denied
- Tests passing
- No secrets in code/log output
- Contract and validation invariants preserved
