name: Publish NPM Package

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: read
  id-token: write

jobs:
  build-binaries:
    name: Build binary (${{ matrix.build.PKG_KEY }})
    runs-on: ${{ matrix.build.OS }}
    strategy:
      fail-fast: false
      matrix:
        build:
          - {
              PKG_KEY: linux-x64,
              OS: ubuntu-24.04,
              TARGET: x86_64-unknown-linux-gnu,
              BIN: mail-imap-mcp-rs,
            }
          - {
              PKG_KEY: darwin-x64,
              OS: macos-latest,
              TARGET: x86_64-apple-darwin,
              BIN: mail-imap-mcp-rs,
            }
          - {
              PKG_KEY: darwin-arm64,
              OS: macos-14,
              TARGET: aarch64-apple-darwin,
              BIN: mail-imap-mcp-rs,
            }
          - {
              PKG_KEY: windows-x64,
              OS: windows-2022,
              TARGET: x86_64-pc-windows-msvc,
              BIN: mail-imap-mcp-rs.exe,
            }

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.build.TARGET }}

      - name: Build binary
        run: cargo build --release --locked --target ${{ matrix.build.TARGET }}

      - name: Prepare artifact
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "artifact/${{ matrix.build.PKG_KEY }}"
          cp "target/${{ matrix.build.TARGET }}/release/${{ matrix.build.BIN }}" "artifact/${{ matrix.build.PKG_KEY }}/${{ matrix.build.BIN }}"
          if [ "${{ matrix.build.BIN }}" != "mail-imap-mcp-rs.exe" ]; then
            chmod +x "artifact/${{ matrix.build.PKG_KEY }}/${{ matrix.build.BIN }}"
          fi

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: npm-bin-${{ matrix.build.PKG_KEY }}
          path: artifact/${{ matrix.build.PKG_KEY }}

  publish-npm:
    name: Publish @bradsjm/mail-imap-mcp-rs
    needs: [build-binaries]
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set release version
        shell: bash
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"
          export version
          node -e 'const fs = require("node:fs"); const p = "npm/app/package.json"; const pkg = JSON.parse(fs.readFileSync(p, "utf8")); pkg.version = process.env.version; fs.writeFileSync(p, JSON.stringify(pkg, null, 2) + "\n");'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.14.0"
          registry-url: "https://registry.npmjs.org"

      - name: Ensure npm version for trusted publishing
        shell: bash
        run: |
          set -euo pipefail
          npm i -g npm@11.5.1
          npm --version

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          pattern: npm-bin-*
          merge-multiple: true
          path: npm/app/bin

      - name: Verify bundled binaries
        shell: bash
        run: |
          set -euo pipefail
          test -f npm/app/bin/linux-x64/mail-imap-mcp-rs
          test -f npm/app/bin/darwin-x64/mail-imap-mcp-rs
          test -f npm/app/bin/darwin-arm64/mail-imap-mcp-rs
          test -f npm/app/bin/windows-x64/mail-imap-mcp-rs.exe

      - name: Publish package
        shell: bash
        run: |
          set -euo pipefail
          cd npm/app
          if [ -n "${NPM_TOKEN:-}" ]; then
            echo "Publishing with NPM_TOKEN (bootstrap mode for first package publish)."
            npm publish --access public
          else
            echo "Publishing with npm trusted publishing (OIDC)."
            npm publish --access public --provenance
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
