name: Publish Docker Image

on:
    workflow_dispatch:

permissions:
    contents: read
    packages: write

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ghcr.io/${{ github.repository }}

jobs:
    meta:
        runs-on: ubuntu-24.04
        outputs:
            tags: ${{ steps.meta.outputs.tags }}
            labels: ${{ steps.meta.outputs.labels }}
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - id: version
              name: Resolve package version tag
              shell: bash
              run: |
                  VERSION=$(awk '
                    $0 ~ /^\[package\]$/ { in_package=1; next }
                    $0 ~ /^\[/ { in_package=0 }
                    in_package && $0 ~ /^version = / {
                      gsub(/version = "|"/, "", $0)
                      print $0
                      exit
                    }
                  ' Cargo.toml)

                  if [ -z "$VERSION" ]; then
                    echo "Failed to read [package].version from Cargo.toml"
                    exit 1
                  fi

                  echo "tag=v${VERSION}" >> "$GITHUB_OUTPUT"

            - name: Extract Docker metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.IMAGE_NAME }}
                  tags: |
                      type=raw,value=${{ steps.version.outputs.tag }}
                      type=raw,value=latest

    build-amd64:
        needs: meta
        runs-on: ubuntu-24.04
        outputs:
            digest: ${{ steps.build.outputs.digest }}
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push amd64 by digest
              id: build
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: Dockerfile
                  platforms: linux/amd64
                  labels: ${{ needs.meta.outputs.labels }}
                  outputs: type=image,name=${{ env.IMAGE_NAME }},push-by-digest=true,name-canonical=true,push=true
                  cache-from: type=gha,scope=amd64
                  cache-to: type=gha,scope=amd64,mode=max

    build-arm64:
        needs: meta
        runs-on: ubuntu-24.04-arm
        outputs:
            digest: ${{ steps.build.outputs.digest }}
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push arm64 by digest
              id: build
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: Dockerfile
                  platforms: linux/arm64
                  labels: ${{ needs.meta.outputs.labels }}
                  outputs: type=image,name=${{ env.IMAGE_NAME }},push-by-digest=true,name-canonical=true,push=true
                  cache-from: type=gha,scope=arm64
                  cache-to: type=gha,scope=arm64,mode=max

    manifest:
        needs:
            - meta
            - build-amd64
            - build-arm64
        runs-on: ubuntu-24.04
        steps:
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Create and push manifests
              shell: bash
              env:
                  TAGS: ${{ needs.meta.outputs.tags }}
                  AMD_DIGEST: ${{ needs.build-amd64.outputs.digest }}
                  ARM_DIGEST: ${{ needs.build-arm64.outputs.digest }}
              run: |
                  set -euo pipefail

                  while IFS= read -r tag; do
                    [ -z "$tag" ] && continue

                    docker buildx imagetools create \
                      -t "$tag" \
                      "${IMAGE_NAME}@${AMD_DIGEST}" \
                      "${IMAGE_NAME}@${ARM_DIGEST}"
                  done <<< "$TAGS"
