name: Initialize NPM Placeholder Package

# npm now requires packages to exist before Trusted Publishing can be configured.
# Run this once to create a placeholder package for this repository.
#
# After it succeeds, configure Trusted Publishing on npmjs.com:
#   Package Settings > Trusted Publisher > GitHub Actions > bradsjm/mail-imap-mcp-rs

on:
    workflow_dispatch: {}

jobs:
    init-package:
        name: Initialize npm package if missing
        runs-on: ubuntu-24.04
        permissions:
            contents: read
        env:
            NPM_PACKAGE_NAME: "@bradsjm/mail-imap-mcp-rs"
            NPM_PLACEHOLDER_VERSION: "0.0.0"
            NPM_REGISTRY_URL: "https://registry.npmjs.org"
            PACKAGE_DESCRIPTION: "Placeholder for Trusted Publishing setup. This version contains no runtime code."
            PACKAGE_LICENSE: "MIT"
            PACKAGE_REPOSITORY: "https://github.com/bradsjm/mail-imap-mcp-rs"
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: "24"
                  registry-url: "https://registry.npmjs.org"

            - name: Check package and publish placeholder if needed
              shell: bash
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
              run: |
                  set -euo pipefail

                  if [ -z "${NODE_AUTH_TOKEN:-}" ]; then
                    echo "Missing required secret: NPM_TOKEN"
                    echo "Create a scoped npm token with publish access and add it as repository secret NPM_TOKEN."
                    exit 1
                  fi

                  if npm view "$NPM_PACKAGE_NAME" version > /dev/null 2>&1; then
                    current_version=$(npm view "$NPM_PACKAGE_NAME" version)
                    echo "Package already exists: $NPM_PACKAGE_NAME@$current_version"
                    echo "No placeholder publish required."
                    exit 0
                  fi

                  echo "Creating placeholder package: $NPM_PACKAGE_NAME@$NPM_PLACEHOLDER_VERSION"
                  tmp_dir=$(mktemp -d)

                  TMP_DIR="$tmp_dir" node -e "
                    const fs = require('node:fs');
                    const path = require('node:path');
                    const pkg = {
                      name: process.env.NPM_PACKAGE_NAME,
                      version: process.env.NPM_PLACEHOLDER_VERSION,
                      description: process.env.PACKAGE_DESCRIPTION,
                      license: process.env.PACKAGE_LICENSE,
                      repository: {
                        type: 'git',
                        url: 'git+' + process.env.PACKAGE_REPOSITORY + '.git'
                      },
                      bugs: {
                        url: process.env.PACKAGE_REPOSITORY + '/issues'
                      },
                      homepage: process.env.PACKAGE_REPOSITORY + '#readme',
                      files: [],
                      publishConfig: {
                        access: 'public'
                      }
                    };
                    fs.writeFileSync(path.join(process.env.TMP_DIR, 'package.json'), JSON.stringify(pkg, null, 2));
                    fs.writeFileSync(path.join(process.env.TMP_DIR, 'README.md'), '# Placeholder package\n\nThis package exists only to enable npm Trusted Publishing setup.');
                  "

                  (cd "$tmp_dir" && npm publish --access public)
                  rm -rf "$tmp_dir"

                  echo "Created $NPM_PACKAGE_NAME@$NPM_PLACEHOLDER_VERSION"
                  echo "Configure Trusted Publishing: https://www.npmjs.com/package/${NPM_PACKAGE_NAME}/access"
